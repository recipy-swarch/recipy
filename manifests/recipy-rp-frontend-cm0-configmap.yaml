apiVersion: v1
data:
  default.conf.template: "# Redirect all HTTP traffic to HTTPS\nserver {\n    listen 80;\n    server_name localhost;\n\n    return 301 https://\\$host\\$request_uri;\n}\n\n# HTTPS server\nserver {\n    listen 443 ssl;\n    server_name localhost;\n\n    # SSL certs (montados desde ./certs/recipy.crt y recipy.key)\n    ssl_certificate     /etc/ssl/certs/recipy.crt;\n    ssl_certificate_key /etc/ssl/private/recipy.key;\n    ssl_protocols       TLSv1.2 TLSv1.3;\n    ssl_ciphers         HIGH:!aNULL:!MD5;\n\n    # \U0001F6E1️ Headers de seguridad\n        add_header Strict-Transport-Security \"max-age=63072000; includeSubDomains; preload\" always;\n        add_header X-Content-Type-Options \"nosniff\" always;\n        add_header X-Frame-Options \"DENY\" always;\n        add_header Content-Security-Policy \"\n            default-src 'self';\n            script-src 'self' 'unsafe-inline' 'unsafe-eval';\n            style-src 'self' 'unsafe-inline';\n            img-src 'self' data: blob:;\n            font-src 'self' data:;\n            connect-src 'self' https://* http://* ws://* wss://*;\n            media-src 'self' blob:;\n            object-src 'none';\n            frame-ancestors 'none';\n            \" always;\n\n\n    # 1) Rutas estáticas de Next no limitadas\n    location ^~ /_next/ {\n        proxy_pass ${FRONTEND_URL};\n        proxy_set_header Host \\$host;\n        proxy_set_header X-Real-IP \\$remote_addr;\n        proxy_set_header X-Forwarded-For \\$proxy_add_x_forwarded_for;\n        proxy_set_header X-Forwarded-Proto \\$scheme;\n    }\n\n    # 2) Resto de rutas con rate-limiting\n    location / {\n        limit_req zone=myzone burst=20 nodelay;  # ajusta burst a tus necesidades\n        proxy_pass ${FRONTEND_URL};\n        proxy_set_header Host \\$host;\n        proxy_set_header X-Real-IP \\$remote_addr;\n        proxy_set_header X-Forwarded-For \\$proxy_add_x_forwarded_for;\n        proxy_set_header X-Forwarded-Proto \\$scheme;\n\n        proxy_cache frontend_cache;\n        proxy_cache_valid 200 1m; # Cachea respuestas 200 por 1 minuto\n        proxy_cache_use_stale error timeout updating http_500 http_502 http_503 http_504;\n        add_header X-Cache-Status \\$upstream_cache_status;\n    }\n}\n\n\n"
kind: ConfigMap
metadata:
  annotations:
    use-subpath: "true"
  labels:
    io.kompose.service: recipy-rp-frontend
  name: recipy-rp-frontend-cm0
